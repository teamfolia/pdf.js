import FoliaCreateComment from "../web-components/folia-create-comment";
import { toPdfPoint } from "../folia-util";
import BaseBuilder from "./base-builder";
import { ANNOTATION_TYPES, USER_ROLE } from "../constants";
import { v4 as uuid } from "uuid";

class CommentBuilder extends BaseBuilder {
  constructor(...props) {
    super(...props);
    this.annotationData = [];
  }

  resume() {
    if (!this.canvas) {
      this.canvas = document.createElement("div");
      this.canvas.className = "annotation-builder-container";
      this.canvas.width = this.foliaPageLayer.pageDiv.clientWidth;
      this.canvas.height = this.foliaPageLayer.pageDiv.clientHeight;
      this.canvas.onclick = this.onMouseClick.bind(this);
      this.canvas.style.cursor = `url("data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMjAiIGhlaWdodD0iMjAiIHZpZXdCb3g9IjAgMCAyMCAyMCIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KICAgIDxwYXRoIGQ9Ik0wIDEwQzAgNC40NzcxNiA0LjQ3NzE2IDAgMTAgMEgxMC42NjY3QzE1LjgyMTMgMCAyMCA0LjE3ODY4IDIwIDkuMzMzMzNWOS4zMzMzM0MyMCAxNS4yMjQ0IDE1LjIyNDQgMjAgOS4zMzMzNSAyMEgwVjEwWiIgZmlsbD0ibm9uZSIvPgogICAgPHBhdGggZD0iTTEwIDAuNzVIMTAuNjY2N0MxNS40MDcxIDAuNzUgMTkuMjUgNC41OTI4OSAxOS4yNSA5LjMzMzMzQzE5LjI1IDE0LjgxMDIgMTQuODEwMiAxOS4yNSA5LjMzMzM1IDE5LjI1SDAuNzVWMTBDMC43NSA0Ljg5MTM3IDQuODkxMzcgMC43NSAxMCAwLjc1WiIgc3Ryb2tlPSIjMzM0MTU1IiBzdHJva2Utd2lkdGg9IjEuNSIvPgo8L3N2Zz4K") 0 20, move`;
    }
    this.foliaPageLayer.pageDiv.appendChild(this.canvas);
    localStorage.removeItem("folia-create-comment");
  }

  prepareAnnotations2save() {
    return this.annotationData;
  }

  getRelativePoint(e) {
    let reference;
    const offset = {
      left: e.currentTarget.offsetLeft,
      top: e.currentTarget.offsetTop,
    };
    reference = e.currentTarget.offsetParent;
    do {
      offset.left += reference.offsetLeft;
      offset.top += reference.offsetTop - reference.scrollTop;
      reference = reference.offsetParent;
    } while (reference);

    return {
      x: e.pageX - offset.left,
      y: e.pageY - offset.top,
    };
  }

  onMouseClick(e) {
    e.preventDefault();
    e.stopPropagation();

    let { x, y } = this.getRelativePoint(e);
    // x -= 20;
    y -= 25;

    let commentPointer = this.canvas.querySelector(".comment-pointer");
    if (commentPointer) commentPointer.remove();

    commentPointer = document.createElement("div");
    commentPointer.className = "comment-pointer";
    commentPointer.onclick = (e) => e.stopPropagation();
    commentPointer.style.left = `${x}px`;
    commentPointer.style.top = `${y}px`;

    const avatar = document.createElement("canvas");
    avatar.width = 20;
    avatar.height = 20;
    const avatarCtx = avatar.getContext("2d");
    avatarCtx.fillStyle = "lightgreen";
    avatarCtx.arc(10, 10, 10, 0, 2 * Math.PI);
    avatarCtx.fill();

    commentPointer.style.background = `white url("${avatar.toDataURL()}") no-repeat center`;

    const createCommentEl = document.createElement("folia-create-comment");
    createCommentEl.className = "folia-create-comment";
    createCommentEl.addEventListener("submit-comment", (e) => {
      const now = new Date().toISOString();
      const commentId = uuid();
      const initialReply = {
        __typename: ANNOTATION_TYPES.REPLY,
        id: uuid(),
        commentId: commentId,
        createdAt: now,
        addedAt: now,
        collaboratorName: this.foliaPageLayer.dataProxy.userName,
        text: e.detail.text,
      };
      const comment = {
        __typename: ANNOTATION_TYPES.COMMENT,
        id: commentId,
        createdAt: now,
        addedAt: now,
        anchorPoint: toPdfPoint(
          { x, y },
          this.foliaPageLayer.viewport.width,
          this.foliaPageLayer.viewport.height
        ),
        replies: [initialReply],
        collaboratorName: this.foliaPageLayer.dataProxy.userName,
        permissions: this.foliaPageLayer.dataProxy.permissions,
        userRole: USER_ROLE.OWNER,
      };
      // console.log("post comment on ", { x, y }, e.detail);
      this.annotationData = [comment, initialReply];
      this.foliaPageLayer.eventBus.dispatch("stop-drawing");
    });
    commentPointer.appendChild(createCommentEl);

    this.canvas.appendChild(commentPointer);
  }
}

export default CommentBuilder;
